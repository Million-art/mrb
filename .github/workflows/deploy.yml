name: Mini App Frontend Deployment

on:
  push:
    branches: [main]

jobs:
  deploy-mini-app:
    runs-on: ubuntu-latest

    steps:
      - name: ‚úÖ Checkout code
        uses: actions/checkout@v4

      - name: üîê Docker Hub Login
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | \
          docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: üõ† Build Docker Image
        run: |
          docker build \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/mini_app:latest \
            .

      - name: üöÄ Push Docker Image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/mini_app:latest

      - name: üñ•Ô∏è Deploy to Server
        env:
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            echo "üîê Connected to production server"
            
            cd /home/million/mrbeas || exit 1
            
            echo "‚¨áÔ∏è Pulling latest mini_app image..."
            docker-compose pull mini_app
            
            echo "üîÑ Updating mini_app service..."
            docker-compose up -d --no-deps mini_app
            
            echo "üîÑ Reloading Caddy reverse proxy..."
            docker exec caddy_reverse_proxy caddy reload
            
            echo "üßπ Cleaning old images..."
            docker image prune -af --filter "until=24h"
            
            echo "‚úÖ Mini App deployment complete!"
          EOF